pipeline {
    agent any

    environment {
        ANDROID_HOME = "/usr/lib/android-sdk"
        PATH = "${ANDROID_HOME}/emulator:${ANDROID_HOME}/cmdline-tools/latest/bin:${ANDROID_HOME}/platform-tools:$PATH"
        ANDROID_AVD_HOME = "/var/lib/jenkins/.android/avd"
    }

    stages {
        stage('Build APK') {
            steps {
                sh './gradlew assembleDebug'
            }
        }

        stage('Unit Test') {
            steps {
                sh './gradlew testDebugUnitTest'
            }
        }

        stage('Start Emulator') {
            steps {
                script {
                    // Run emulator startup in a background process detached from Jenkins shell
                    sh """
                        echo "Launching emulator in background..."
                        setsid emulator -avd MyAVD -no-audio -no-window -no-boot-anim -wipe-data > /tmp/emulator.log 2>&1 &
                    """
                }
            }
        }

        stage('Wait for Emulator Boot') {
            steps {
                sh '''
                    echo "Waiting for ADB to detect emulator..."
                    adb wait-for-device

                    echo "Checking if emulator booted completely..."
                    BOOT_COMPLETED=""
                    ATTEMPTS=0
                    MAX_ATTEMPTS=30

                    while [ "$BOOT_COMPLETED" != "1" -a $ATTEMPTS -lt $MAX_ATTEMPTS ]; do
                        BOOT_COMPLETED=$(adb shell getprop sys.boot_completed | tr -d '\r')
                        echo "Attempt $ATTEMPTS: Boot completed = $BOOT_COMPLETED"
                        sleep 5
                        ATTEMPTS=$((ATTEMPTS + 1))
                    done

                    if [ "$BOOT_COMPLETED" != "1" ]; then
                        echo "Emulator failed to boot in time."
                        cat /tmp/emulator.log
                        exit 1
                    fi

                    echo "Emulator is ready."
                '''
            }
        }

stage('Install APK & Launch App') {
    steps {
        sh '''
            echo "Installing APK..."
            adb install -r app/build/outputs/apk/debug/app-debug.apk

            echo "Verifying installation..."
            adb shell pm list packages | grep com.example.d4capp || true

            echo "Launching app..."
            adb shell monkey -p com.example.d4capp -c android.intent.category.LAUNCHER 1
        '''
    }
}

        stage('Archive APK') {
            steps {
                archiveArtifacts artifacts: '**/build/outputs/**/*.apk', fingerprint: true
            }
        }
    }

    post {
        always {
            echo "Stopping emulator (if running)..."
            sh '''
                adb emu kill || true
                pkill -f "emulator -avd" || true
            '''
        }
    }
}
