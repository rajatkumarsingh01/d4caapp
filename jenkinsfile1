pipeline {
    agent any

    environment {
        ANDROID_HOME = "/usr/lib/android-sdk"
        PATH = "${ANDROID_HOME}/emulator:${ANDROID_HOME}/cmdline-tools/latest/bin:${ANDROID_HOME}/platform-tools:$PATH"
        ANDROID_AVD_HOME = "/var/lib/jenkins/.android/avd"
    }

    stages {
        stage('Build APK') {
            steps {
                sh './gradlew assembleDebug'
            }
        }

        stage('Unit Test') {
            steps {
                sh './gradlew testDebugUnitTest'
            }
        }

        stage('Start Emulator & Install APK') {
    steps {
        sh '''
            echo "Starting emulator in headless mode..."
            nohup emulator -avd MyAVD -no-audio -no-window > /tmp/emulator.log 2>&1 &

            echo "Waiting for emulator to boot..."
            adb wait-for-device

            # Check boot completion
            boot_completed=""
            until [[ "$boot_completed" == "1" ]]; do
                boot_completed=$(adb shell getprop sys.boot_completed 2>/dev/null | tr -d '\r')
                echo "Boot completed: $boot_completed"
                sleep 5
            done

            echo "Installing APK..."
            adb install -r app/build/outputs/apk/debug/app-debug.apk
        '''
    }
}

        stage('Archive APK') {
            steps {
                archiveArtifacts artifacts: '**/build/outputs/**/*.apk', fingerprint: true
            }
        }
    }
}
